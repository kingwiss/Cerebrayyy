<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Daily Content System Test</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .test-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .test-button.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .test-button.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .test-results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success {
            background: #28a745;
        }
        
        .status-warning {
            background: #ffc107;
        }
        
        .status-error {
            background: #dc3545;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .test-card.new-content {
            border-left-color: #28a745;
            background: #f8fff9;
        }
        
        .test-card-type {
            font-size: 0.8rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .test-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .test-card-description {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }
        
        .new-badge {
            background: #28a745;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1><i class="fas fa-flask"></i> Daily Content System Test</h1>
            <p>Comprehensive testing of the 40-cards-per-day backend system</p>
        </div>
        
        <!-- System Status -->
        <div class="test-section">
            <h3><i class="fas fa-heartbeat"></i> System Status</h3>
            <div id="systemStatus">
                <div><span class="status-indicator status-warning"></span> Initializing...</div>
            </div>
            <button class="test-button" onclick="checkSystemStatus()">
                <i class="fas fa-sync-alt"></i> Refresh Status
            </button>
        </div>
        
        <!-- User Information -->
        <div class="test-section">
            <h3><i class="fas fa-user"></i> User Information</h3>
            <div id="userInfo">Loading...</div>
            <button class="test-button" onclick="showUserInfo()">
                <i class="fas fa-info-circle"></i> Show User Info
            </button>
        </div>
        
        <!-- Daily Cards Testing -->
        <div class="test-section">
            <h3><i class="fas fa-cards-blank"></i> Daily Cards Testing</h3>
            <div>
                <button class="test-button" onclick="loadTodaysCards()">
                    <i class="fas fa-calendar-day"></i> Load Today's Cards
                </button>
                <button class="test-button" onclick="testNewContentRatio()">
                    <i class="fas fa-percentage"></i> Test 80% New Content
                </button>
                <button class="test-button" onclick="simulateCardViewing()">
                    <i class="fas fa-eye"></i> Simulate Card Viewing
                </button>
            </div>
            <div id="cardsTestResults" class="test-results" style="display: none;"></div>
            <div id="cardsDisplay" class="cards-grid"></div>
        </div>
        
        <!-- Content Pool Testing -->
        <div class="test-section">
            <h3><i class="fas fa-database"></i> Content Pool Testing</h3>
            <div>
                <button class="test-button" onclick="testContentPools()">
                    <i class="fas fa-list"></i> Test Content Pools
                </button>
                <button class="test-button" onclick="testContentDistribution()">
                    <i class="fas fa-chart-pie"></i> Test Distribution
                </button>
            </div>
            <div id="contentPoolResults" class="test-results" style="display: none;"></div>
        </div>
        
        <!-- Storage Testing -->
        <div class="test-section">
            <h3><i class="fas fa-save"></i> Storage Testing</h3>
            <div>
                <button class="test-button" onclick="testLocalStorage()">
                    <i class="fas fa-hdd"></i> Test Local Storage
                </button>
                <button class="test-button" onclick="showStorageUsage()">
                    <i class="fas fa-chart-bar"></i> Storage Usage
                </button>
                <button class="test-button danger" onclick="clearTestData()">
                    <i class="fas fa-trash"></i> Clear Test Data
                </button>
            </div>
            <div id="storageResults" class="test-results" style="display: none;"></div>
        </div>
        
        <!-- Performance Testing -->
        <div class="test-section">
            <h3><i class="fas fa-tachometer-alt"></i> Performance Testing</h3>
            <div>
                <button class="test-button" onclick="testGenerationSpeed()">
                    <i class="fas fa-stopwatch"></i> Test Generation Speed
                </button>
                <button class="test-button" onclick="testMemoryUsage()">
                    <i class="fas fa-memory"></i> Memory Usage
                </button>
            </div>
            <div id="performanceResults" class="test-results" style="display: none;"></div>
        </div>
        
        <!-- Navigation -->
        <div class="test-section">
            <h3><i class="fas fa-external-link-alt"></i> Navigation</h3>
            <div>
                <a href="index.html" class="test-button success">
                    <i class="fas fa-home"></i> Go to Main App
                </a>
            </div>
        </div>
    </div>

    <!-- Daily Content Backend System -->
    <script src="daily-content-backend.js"></script>
    
    <script>
        let dailyBackend = null;
        let testResults = {};
        
        // Initialize test system
        async function initializeTestSystem() {
            try {
                console.log('üß™ Initializing Test System...');
                
                // Wait for DailyContentBackend to be available
                if (typeof DailyContentBackend === 'undefined') {
                    console.log('‚è≥ Waiting for DailyContentBackend to load...');
                    await waitForDailyContentBackend();
                }
                
                dailyBackend = new DailyContentBackend();
                checkSystemStatus();
                showUserInfo();
                
            } catch (error) {
                console.error('‚ùå Failed to initialize test system:', error);
                updateSystemStatus('error', 'Failed to initialize system');
            }
        }
        
        // Wait for DailyContentBackend to be loaded
        function waitForDailyContentBackend() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (typeof DailyContentBackend !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
                
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve();
                }, 5000);
            });
        }
        
        // Check system status
        function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            
            if (!dailyBackend) {
                updateSystemStatus('error', 'Daily Content Backend not initialized');
                return;
            }
            
            try {
                const stats = dailyBackend.getUserStats();
                const cards = dailyBackend.getTodaysCards();
                
                statusDiv.innerHTML = `
                    <div><span class="status-indicator status-success"></span> Daily Content Backend: Active</div>
                    <div><span class="status-indicator status-success"></span> Today's Cards: ${cards.length} generated</div>
                    <div><span class="status-indicator status-success"></span> User ID: ${stats.userId}</div>
                    <div><span class="status-indicator status-success"></span> Local Storage: Working</div>
                `;
            } catch (error) {
                updateSystemStatus('error', `System check failed: ${error.message}`);
            }
        }
        
        // Update system status
        function updateSystemStatus(type, message) {
            const statusDiv = document.getElementById('systemStatus');
            const statusClass = type === 'success' ? 'status-success' : 
                               type === 'warning' ? 'status-warning' : 'status-error';
            
            statusDiv.innerHTML = `<div><span class="status-indicator ${statusClass}"></span> ${message}</div>`;
        }
        
        // Show user information
        function showUserInfo() {
            if (!dailyBackend) return;
            
            const stats = dailyBackend.getUserStats();
            const userInfoDiv = document.getElementById('userInfo');
            
            userInfoDiv.innerHTML = `
                <div><strong>User ID:</strong> ${stats.userId}</div>
                <div><strong>Join Date:</strong> ${stats.joinDate}</div>
                <div><strong>Days Active:</strong> ${stats.daysActive}</div>
                <div><strong>Total Cards Viewed:</strong> ${stats.totalCardsViewed}</div>
                <div><strong>Seen Content Count:</strong> ${stats.seenContentCount}</div>
                <div><strong>Today's Stats:</strong> ${stats.todayStats ? JSON.stringify(stats.todayStats) : 'None'}</div>
            `;
        }
        
        // Load today's cards
        function loadTodaysCards() {
            if (!dailyBackend) return;
            
            const cards = dailyBackend.getTodaysCards();
            const resultsDiv = document.getElementById('cardsTestResults');
            const displayDiv = document.getElementById('cardsDisplay');
            
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                ‚úÖ Successfully loaded ${cards.length} cards for today
                üìä Content breakdown:
                - Fun Facts: ${cards.filter(c => c.type !== 'Activity' && c.type !== 'Riddle' && c.type !== 'Math Challenge').length}
                - Activities: ${cards.filter(c => c.type === 'Activity').length}
                - Riddles: ${cards.filter(c => c.type === 'Riddle').length}
                - Math Challenges: ${cards.filter(c => c.type === 'Math Challenge').length}
                
                üÜï New content: ${cards.filter(c => c.isNew).length} cards (${Math.round((cards.filter(c => c.isNew).length / cards.length) * 100)}%)
            `;
            
            // Display first 12 cards
            displayDiv.innerHTML = '';
            const previewCards = cards.slice(0, 12);
            
            previewCards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = `test-card ${card.isNew ? 'new-content' : ''}`;
                
                cardDiv.innerHTML = `
                    <div class="test-card-type">
                        ${card.type}
                        ${card.isNew ? '<span class="new-badge">NEW</span>' : ''}
                    </div>
                    <div class="test-card-title">${card.title}</div>
                    <div class="test-card-description">${card.description.substring(0, 100)}...</div>
                `;
                
                displayDiv.appendChild(cardDiv);
            });
        }
        
        // Test new content ratio
        function testNewContentRatio() {
            if (!dailyBackend) return;
            
            const cards = dailyBackend.getTodaysCards();
            const newCards = cards.filter(c => c.isNew);
            const newContentRatio = (newCards.length / cards.length) * 100;
            
            const resultsDiv = document.getElementById('cardsTestResults');
            resultsDiv.style.display = 'block';
            
            const passed = newContentRatio >= 80;
            const status = passed ? '‚úÖ PASSED' : '‚ùå FAILED';
            
            resultsDiv.innerHTML = `
                ${status} New Content Ratio Test
                
                üìä Results:
                - Total cards: ${cards.length}
                - New cards: ${newCards.length}
                - New content ratio: ${newContentRatio.toFixed(1)}%
                - Target: 80%
                - Status: ${passed ? 'PASSED' : 'FAILED - Below 80% threshold'}
            `;
        }
        
        // Simulate card viewing
        function simulateCardViewing() {
            if (!dailyBackend) return;
            
            const cards = dailyBackend.getTodaysCards();
            const viewCount = Math.min(10, cards.length);
            
            for (let i = 0; i < viewCount; i++) {
                dailyBackend.markCardAsViewed(cards[i].contentId);
            }
            
            const resultsDiv = document.getElementById('cardsTestResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                ‚úÖ Simulated viewing ${viewCount} cards
                üìä Updated user stats:
                ${JSON.stringify(dailyBackend.getUserStats(), null, 2)}
            `;
        }
        
        // Test content pools
        function testContentPools() {
            if (!dailyBackend) return;
            
            const resultsDiv = document.getElementById('contentPoolResults');
            resultsDiv.style.display = 'block';
            
            const pools = dailyBackend.contentPools;
            let poolInfo = 'üìä Content Pool Analysis:\n\n';
            
            // Test fun facts
            poolInfo += 'Fun Facts:\n';
            Object.keys(pools.funFacts).forEach(category => {
                poolInfo += `  - ${category}: ${pools.funFacts[category].length} facts\n`;
            });
            
            // Test activities
            poolInfo += '\nActivities:\n';
            Object.keys(pools.activities).forEach(category => {
                poolInfo += `  - ${category}: ${pools.activities[category].length} activities\n`;
            });
            
            // Test riddles and math
            poolInfo += `\nRiddles: ${pools.riddles.length} items\n`;
            poolInfo += `Math Challenges: ${pools.mathChallenges.length} items\n`;
            
            resultsDiv.innerHTML = poolInfo;
        }
        
        // Test content distribution
        function testContentDistribution() {
            if (!dailyBackend) return;
            
            const cards = dailyBackend.getTodaysCards();
            const distribution = {};
            
            cards.forEach(card => {
                distribution[card.type] = (distribution[card.type] || 0) + 1;
            });
            
            const resultsDiv = document.getElementById('contentPoolResults');
            resultsDiv.style.display = 'block';
            
            let distInfo = 'üìä Content Distribution Analysis:\n\n';
            Object.keys(distribution).forEach(type => {
                const percentage = ((distribution[type] / cards.length) * 100).toFixed(1);
                distInfo += `${type}: ${distribution[type]} cards (${percentage}%)\n`;
            });
            
            resultsDiv.innerHTML = distInfo;
        }
        
        // Test local storage
        function testLocalStorage() {
            const resultsDiv = document.getElementById('storageResults');
            resultsDiv.style.display = 'block';
            
            try {
                // Test storage functionality
                const testKey = 'boredom_buster_test';
                const testData = { test: true, timestamp: Date.now() };
                
                localStorage.setItem(testKey, JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem(testKey));
                localStorage.removeItem(testKey);
                
                const storageWorks = retrieved && retrieved.test === true;
                
                resultsDiv.innerHTML = `
                    ‚úÖ Local Storage Test: ${storageWorks ? 'PASSED' : 'FAILED'}
                    
                    üìä Storage Keys Analysis:
                    ${Object.keys(localStorage).filter(key => key.includes('boredom')).map(key => 
                        `- ${key}: ${(localStorage.getItem(key).length / 1024).toFixed(2)} KB`
                    ).join('\n')}
                `;
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Local Storage Test FAILED: ${error.message}`;
            }
        }
        
        // Show storage usage
        function showStorageUsage() {
            const resultsDiv = document.getElementById('storageResults');
            resultsDiv.style.display = 'block';
            
            let totalSize = 0;
            let boredomBusterSize = 0;
            const keys = Object.keys(localStorage);
            
            keys.forEach(key => {
                const size = localStorage.getItem(key).length;
                totalSize += size;
                if (key.includes('boredom') || key.includes('daily') || key.includes('user_progress')) {
                    boredomBusterSize += size;
                }
            });
            
            resultsDiv.innerHTML = `
                üìä Storage Usage Analysis:
                
                Total localStorage usage: ${(totalSize / 1024).toFixed(2)} KB
                Cerebray usage: ${(boredomBusterSize / 1024).toFixed(2)} KB
                Number of keys: ${keys.length}
                
                üéØ Cerebray Keys:
                ${keys.filter(key => key.includes('boredom') || key.includes('daily') || key.includes('user_progress'))
                    .map(key => `- ${key}: ${(localStorage.getItem(key).length / 1024).toFixed(2)} KB`)
                    .join('\n')}
            `;
        }
        
        // Clear test data
        function clearTestData() {
            if (confirm('Are you sure you want to clear all test data? This will reset your progress.')) {
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.includes('boredom') || key.includes('daily') || key.includes('user_progress')) {
                        localStorage.removeItem(key);
                    }
                });
                
                const resultsDiv = document.getElementById('storageResults');
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '‚úÖ Test data cleared successfully. Refresh the page to reinitialize.';
            }
        }
        
        // Test generation speed
        function testGenerationSpeed() {
            const resultsDiv = document.getElementById('performanceResults');
            resultsDiv.style.display = 'block';
            
            const startTime = performance.now();
            
            try {
                // Create a new backend instance to test generation speed
                const testBackend = new DailyContentBackend();
                const cards = testBackend.getTodaysCards();
                
                const endTime = performance.now();
                const generationTime = endTime - startTime;
                
                resultsDiv.innerHTML = `
                    ‚ö° Performance Test Results:
                    
                    Generation time: ${generationTime.toFixed(2)}ms
                    Cards generated: ${cards.length}
                    Average per card: ${(generationTime / cards.length).toFixed(2)}ms
                    
                    Performance rating: ${generationTime < 100 ? 'üü¢ Excellent' : 
                                        generationTime < 500 ? 'üü° Good' : 'üî¥ Needs optimization'}
                `;
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Performance test failed: ${error.message}`;
            }
        }
        
        // Test memory usage
        function testMemoryUsage() {
            const resultsDiv = document.getElementById('performanceResults');
            resultsDiv.style.display = 'block';
            
            if ('memory' in performance) {
                const memory = performance.memory;
                resultsDiv.innerHTML = `
                    üß† Memory Usage:
                    
                    Used JS Heap: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB
                    Total JS Heap: ${(memory.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB
                    Heap Limit: ${(memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB
                    
                    Usage: ${((memory.usedJSHeapSize / memory.jsHeapSizeLimit) * 100).toFixed(1)}%
                `;
            } else {
                resultsDiv.innerHTML = '‚ö†Ô∏è Memory usage information not available in this browser.';
            }
        }
        
        // Initialize test system when page loads
        document.addEventListener('DOMContentLoaded', initializeTestSystem);
    </script>
</body>
</html>