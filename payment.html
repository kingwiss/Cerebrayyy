<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cerebray Premium - Payment</title>
    <script src="https://www.paypal.com/sdk/js?client-id=AU0wG24em8WTPFJPe2uchMR_zbyjPf9EykqV_IKUpESVdmPQbAUe8cZAwvZ82mcCzUG8DdiukyHFjULz&vault=true&intent=subscription"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .payment-container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .crown-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1em;
        }

        .order-summary {
            background: #f8f9fa;
            margin: 30px;
            padding: 20px;
            border-radius: 12px;
        }

        .order-summary h3 {
            color: #333;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            color: #666;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0 0 0;
            margin-top: 15px;
            border-top: 2px solid #e9ecef;
            font-size: 1.1em;
        }

        .total-price {
            color: #667eea;
            font-size: 1.2em;
        }

        .payment-section {
            padding: 0 30px 30px 30px;
        }

        .payment-section h3 {
            color: #333;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .paypal-button-container {
            margin: 20px 0;
            min-height: 55px;
        }

        .error-message {
            color: #dc3545;
            font-size: 13px;
            margin-top: 5px;
            min-height: 18px;
            text-align: center;
        }

        .success-message {
            color: #28a745;
            font-size: 14px;
            margin-bottom: 15px;
            padding: 10px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            display: none;
            text-align: center;
        }

        .success-message.show {
            display: block;
        }

        .security-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
            color: #666;
            font-size: 13px;
        }

        .features-list {
            background: #f8f9fa;
            margin: 20px 30px;
            padding: 20px;
            border-radius: 12px;
        }

        .features-list h4 {
            color: #333;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            color: #666;
            font-size: 14px;
        }

        .feature-item::before {
            content: "‚úÖ";
            margin-right: 10px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .order-summary {
                margin: 20px;
            }
            
            .payment-section {
                padding: 0 20px 20px 20px;
            }
            
            .features-list {
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="header">
            <div class="crown-icon">üëë</div>
            <h1>Cerebray Premium</h1>
            <p class="subtitle">Unlock unlimited access to premium features</p>
        </div>

        <div class="order-summary">
            <h3>Order Summary</h3>
            <div class="summary-item">
                <span>Cerebray Premium Monthly</span>
                <span>$4.99</span>
            </div>
            <div class="summary-item">
                <span>Billing Cycle</span>
                <span>Monthly</span>
            </div>
            <div class="summary-total">
                <strong>Total Today</strong>
                <strong class="total-price">$4.99/month</strong>
            </div>
        </div>

        <div class="features-list">
            <h4>What's Included:</h4>
            <div class="feature-item">Unlimited premium games and activities</div>
            <div class="feature-item">Advanced AI-powered learning tools</div>
            <div class="feature-item">Priority customer support</div>
            <div class="feature-item">Ad-free experience</div>
            <div class="feature-item">Exclusive premium content</div>
            <div class="feature-item">Cancel anytime</div>
        </div>

        <div class="payment-section">
            <h3>Complete Your Subscription</h3>
            
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" placeholder="Enter your email address" required>
                <div class="error-message" id="email-error"></div>
            </div>

            <div class="success-message" id="payment-success"></div>
            <div class="error-message" id="payment-errors"></div>

            <div id="paypal-button-container" class="paypal-button-container"></div>

            <div class="security-info">
                <span>üîí Secure Payment</span>
                <span>üí≥ Powered by PayPal</span>
                <span>üõ°Ô∏è Cancel Anytime</span>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Processing your subscription...</p>
        </div>
    </div>

    <script>
        class PayPalPaymentProcessor {
            constructor() {
                this.email = '';
                this.isProcessing = false;
                this.init();
            }

            init() {
                console.log('üöÄ Initializing PayPal payment system...');
                this.setupEmailValidation();
                this.renderPayPalButton();
            }

            setupEmailValidation() {
                const emailInput = document.getElementById('email');
                emailInput.addEventListener('blur', () => {
                    this.validateEmail();
                });
                emailInput.addEventListener('input', () => {
                    this.clearError('email-error');
                });
            }

            validateEmail() {
                const emailInput = document.getElementById('email');
                const email = emailInput.value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                if (!email) {
                    this.showError('email-error', 'Email address is required');
                    return false;
                }

                if (!emailRegex.test(email)) {
                    this.showError('email-error', 'Please enter a valid email address');
                    return false;
                }

                this.email = email;
                this.clearError('email-error');
                return true;
            }

            renderPayPalButton() {
                console.log('üîß Rendering PayPal subscription button...');
                
                paypal.Buttons({
                    style: {
                        shape: 'rect',
                        color: 'blue',
                        layout: 'vertical',
                        label: 'subscribe',
                        height: 55
                    },
                    
                    createSubscription: (data, actions) => {
                        console.log('üîÑ Creating PayPal subscription...');
                        
                        if (!this.validateEmail()) {
                            this.showError('payment-errors', 'Please enter a valid email address first');
                            return Promise.reject(new Error('Invalid email'));
                        }

                        this.showLoading();

                        return actions.subscription.create({
                            'plan_id': 'P-2BW31317971447626NCRS6WI', // Your PayPal plan ID
                            'subscriber': {
                                'email_address': this.email
                            },
                            'application_context': {
                                'brand_name': 'Cerebray Premium',
                                'locale': 'en-US',
                                'shipping_preference': 'NO_SHIPPING',
                                'user_action': 'SUBSCRIBE_NOW',
                                'payment_method': {
                                    'payer_selected': 'PAYPAL',
                                    'payee_preferred': 'IMMEDIATE_PAYMENT_REQUIRED'
                                },
                                'return_url': window.location.origin + '/payment-success.html',
                                'cancel_url': window.location.origin + '/payment.html'
                            }
                        });
                    },

                    onApprove: async (data, actions) => {
                        console.log('‚úÖ PayPal subscription approved:', data.subscriptionID);
                        
                        try {
                            // Call our backend to handle the subscription
                            const response = await fetch('/api/paypal-subscription-success', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    subscriptionId: data.subscriptionID,
                                    email: this.email,
                                    planId: 'P-2BW31317971447626NCRS6WI'
                                })
                            });

                            const result = await response.json();

                            if (result.success) {
                                // Upgrade user through UserTierManager if available
                                if (window.userTierManager) {
                                    try {
                                        const premiumData = {
                                            subscriptionId: data.subscriptionID,
                                            startDate: new Date().toISOString(),
                                            endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days
                                            status: 'active'
                                        };
                                        await window.userTierManager.upgradeToPremium(premiumData);
                                        console.log('User tier upgraded successfully via UserTierManager');
                                    } catch (error) {
                                        console.error('Error upgrading user tier:', error);
                                    }
                                }
                                
                                this.handleSubscriptionSuccess(data.subscriptionID);
                            } else {
                                throw new Error(result.error || 'Subscription processing failed');
                            }

                        } catch (error) {
                            console.error('‚ùå Error processing subscription:', error);
                            this.showError('payment-errors', 'Subscription processing failed. Please contact support.');
                        } finally {
                            this.hideLoading();
                        }
                    },

                    onError: (err) => {
                        console.error('‚ùå PayPal error:', err);
                        this.hideLoading();
                        this.showError('payment-errors', 'Payment failed. Please try again.');
                    },

                    onCancel: (data) => {
                        console.log('‚ö†Ô∏è PayPal payment cancelled:', data);
                        this.hideLoading();
                        this.showError('payment-errors', 'Payment was cancelled. You can try again anytime.');
                    }

                }).render('#paypal-button-container');

                console.log('‚úÖ PayPal button rendered successfully');
            }

            handleSubscriptionSuccess(subscriptionId) {
                console.log('üéâ Subscription successful:', subscriptionId);
                
                // Store premium access in localStorage
                const premiumData = {
                    isPremium: true,
                    subscriptionId: subscriptionId,
                    email: this.email,
                    activatedAt: new Date().toISOString(),
                    provider: 'paypal',
                    planId: 'P-2BW31317971447626NCRS6WI'
                };

                localStorage.setItem('cerebrayPremium', JSON.stringify(premiumData));
                localStorage.setItem('userEmail', this.email);

                // Show success message
                this.showSuccess();

                // Redirect after delay
                setTimeout(() => {
                    window.location.href = '/?premium=activated';
                }, 3000);
            }

            showLoading() {
                document.getElementById('loading-overlay').style.display = 'flex';
            }

            hideLoading() {
                document.getElementById('loading-overlay').style.display = 'none';
            }

            showError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                errorElement.textContent = message;
                setTimeout(() => {
                    errorElement.textContent = '';
                }, 5000);
            }

            clearError(elementId) {
                const errorElement = document.getElementById(elementId);
                errorElement.textContent = '';
            }

            showSuccess() {
                const successElement = document.getElementById('payment-success');
                successElement.textContent = 'üéâ Subscription successful! Welcome to Cerebray Premium! Redirecting...';
                successElement.classList.add('show');
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM loaded, initializing PayPal payment system...');
            new PayPalPaymentProcessor();
        });
    </script>
</body>
</html>